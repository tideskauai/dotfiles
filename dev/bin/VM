#!/usr/bin/env bash

selected_overlay=""
vm_dir="$HOME/VMs/"
ram="-m 2G"
vnc="-daemonize -vnc 127.0.0.1:1 -k en-us"
net="-net nic,macaddr=DE:AD:BE:EF:00:01 -net bridge,br=br0,helper=/usr/lib/qemu/qemu-bridge-helper"
#############################
## Select an overlay image ##
#############################
overlay_array=($(find $vm_dir -maxdepth 1 -type f -iname '*overlay*'))
iter=${#overlay_array[*]}

for i in $(seq 0 1 $(($iter-1))); do
    echo -n "$i) "
    echo ${overlay_array[$i]}
done
read -p "Choose an overlay image: " given_number
# Only match numbers in the regex
# Also make sure the var is not empty
if [[ $given_number =~ ^[0-9]+$ ]] && [[ -n $given_number ]]; then
    if (($given_number < $iter)); then
        selected_overlay="${overlay_array[$given_number]}"
    else
        echo "The number you wrote is not a valid option"
        exit
    fi
fi
# Exit if selected_overlay remains a null string
if [[ -z $selected_overlay ]]; then
    echo "The var selected_overlay remains a null string"
    exit
fi
###########################
## Do something with the ##
## selected overlay      ##
###########################
# If $1 is a null string
if [[ -z $1 ]]; then
    qemu-system-x86_64 -enable-kvm $ram $selected_overlay &
else
    case "$1" in
        -a | --audio)
            export QEMU_AUDIO_DRV=sdl
            export SDL_AUDIODRIVER=alsa
            # qemu-system-x86_64 -enable-kvm $ram -soundhw hda $vnc $selected_overlay
            qemu-system-x86_64 -enable-kvm $ram -device intel-hda -device hda-duplex $selected_overlay &
            ;;
        -b | --bridge)
            echo "You will need to create a bridge and modify /etc/qemu/bridge.conf"
            echo "1) sudo ip addr flush eth0"
            echo "2) sudo brctl addbr br0"
            echo "3) sudo brctl addif br0 eth0"
            echo "4) sudo dhcpcd br0"
            echo "5) sudo dnsmasq --dhcp-range=192.168.11.111,192.168.11.222,255.255.255.0,2h --interface=tap0"
            echo '6) cd /proc/sys/net/bridge && for f in bridge-nf-*; do echo 0 | sudo tee $f; done'
            echo "====================================================="
            echo "= Use tcpdump -ni tap0 to debug connectivity        ="
            echo "====================================================="
            qemu-system-x86_64 -enable-kvm $ram $net $vnc $selected_overlay &
            ;;
        -v | --vnc)
            qemu-system-x86_64 -enable-kvm $ram $vnc $selected_overlay &
            ;;
        -h | --help)
            echo "Valid args: -b, --bridge, -a, --audio, -v, --vnc, none(defaults)"
            ;;
        *)
            echo "Invalid argument, try again."
            ;;
    esac
fi
